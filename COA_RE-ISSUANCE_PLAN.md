# COA Re-Issuance Plan for All Clients

## Context
All clients need to re-issue their Certificates of Analysis (COAs) using the WhaleTools Generator to ensure:
1. Metadata (completion dates, THC/CBD values, terpenes) can be extracted from PDFs
2. QR code URLs match the correct format
3. Data consistency between PDF content and database records

## Current State

### Database
- `store_documents` table contains 480 COA records
- Some PDFs are text-based (react-pdf generated) - **CAN be parsed** ✅
- Some PDFs are image-based (jsPDF generated) - **CANNOT be parsed** ❌
- Metadata exists in `data` JSONB field but may be incomplete or inaccurate

### Generator App
- Location: `/Users/whale/Desktop/Generator/COA`
- Uses WhaleTools - Next.js app with @react-pdf/renderer
- Generates text-based PDFs that CAN be parsed ✅
- Auto-generates QR codes matching format: `https://www.quantixanalytics.com/coa/{storeId}/{productSlug}`

### Metadata Extraction
- Script: `/Users/whale/Desktop/quantix-new/scripts/parse-coas-with-pdftotext.ts`
- Uses command-line `pdftotext` tool
- Successfully extracts:
  - Completion dates
  - THC/CBD/Terpene values
  - Sample IDs
  - Batch numbers
- **Only works on text-based PDFs generated by @react-pdf/renderer**

## Re-Issuance Workflow

### For Each Client:

#### 1. Preparation
- [ ] Gather original test data for all products:
  - Product names
  - Completion dates (CRITICAL - must be accurate)
  - Cannabinoid profile (THC, CBD, etc.)
  - Sample IDs
  - Batch numbers
  - Strain information
  - Sample type (Flower, Badder, Diamonds, etc.)

#### 2. Generate New COAs
Using WhaleTools Generator (`/Users/whale/Desktop/Generator/COA`):

1. **Start Generator:**
   ```bash
   cd /Users/whale/Desktop/Generator/COA
   npm run dev
   # Opens at http://localhost:3000
   ```

2. **For each product:**
   - Select client/store from dropdown
   - Select "Cannabis COA" template
   - Fill in form fields:
     - **Sample Name**: Product name (e.g., "Grape Ape Badder")
     - **Sample ID**: Auto-generated or enter original
     - **Strain**: Strain name
     - **Sample Type**: Flower, Concentrate, Edible, etc.
     - **Batch ID**: Auto-generated or enter original
     - **Completed Date**: **ENTER ACTUAL COMPLETION DATE** (not today's date!)
     - **Cannabinoids**: Enter THC, CBD, and other values in the table
     - **Client Info**: Auto-populated from store selection

   - **CRITICAL**: The "Completed" date field must be the actual test completion date, not the date you're re-issuing the COA!

   - Click "Export"
   - PDF will download AND upload to database automatically

3. **Verify Upload:**
   - Check that PDF appears in `vendor-coas` storage bucket
   - Verify `store_documents` record was created

#### 3. Verify Metadata Extraction
After re-generating COAs, run the parsing script to verify metadata is extractable:

```bash
cd /Users/whale/Desktop/quantix-new
npm run parse-coas-pdftotext
```

Check that extracted metadata matches what was entered in the Generator.

## Technical Details

### WhaleTools Generator Key Files

**Generate Page**: `/Users/whale/Desktop/Generator/COA/src/app/generate/page.tsx`
- Lines 136-148: Auto-populates client info from selected store
- Lines 151-161: Generates QR code URL based on product name
- Lines 273-295: Initializes cannabinoid array with default values
- Lines 561-719: Export handler - generates PDF and uploads to database

**PDF Generation Edge Function**: `/Users/whale/Desktop/Generator/COA/supabase/functions/generate-pdf/index.ts`
- Lines 1052-1293: Main COA document template
- Lines 1080-1273: Page 1 - Cannabinoid profile (always included)
- Lines 1113-1119: Completion date rendered in PDF (line 1114: `dateTested`)
- Uses `@react-pdf/renderer` to create text-based PDFs

**Database Upload**: `/Users/whale/Desktop/Generator/COA/src/app/generate/page.tsx:689-712`
```typescript
const filePath = `${selectedStoreId}/${fileName}`;

// Upload to storage
await supabase.storage
  .from('vendor-coas')
  .upload(filePath, pdfBlob, { contentType: 'application/pdf', upsert: true });

// Get public URL
const { data: urlData } = supabase.storage
  .from('vendor-coas')
  .getPublicUrl(filePath);

// Create database record
await supabase.from('store_documents').insert({
  store_id: selectedStoreId,
  document_type: 'coa',
  document_name: productName,
  file_name: fileName,
  file_url: urlData.publicUrl,
  data: formData,  // All metadata stored here
  reference_number: sampleId,
  is_active: true,
  is_public: true,
});
```

### QR Code URL Format

Generator creates QR codes with URL:
```
https://www.quantixanalytics.com/coa/{storeId}/{productSlug}
```

Where:
- `storeId`: Store UUID or slug from `stores` table
- `productSlug`: Sanitized product name (spaces → `_`, special chars removed)

Example: `https://www.quantixanalytics.com/coa/Flora_Distro/Grape_Ape_Badder`

### Metadata Fields in `store_documents.data`

From Generator form data (stored in `data` JSONB field):
```typescript
{
  sampleName: "Grape Ape Badder",
  sampleId: "QA20260126SL6M",
  strain: "Grape Ape",
  sampleType: "Concentrate",
  batchId: "BAD-2G-THCA-GA-V2",
  dateCollected: "2026-01-23",
  dateReceived: "2026-01-24",
  dateTested: "2026-01-24",         // THIS IS THE COMPLETION DATE
  dateReported: "2026-01-24",
  clientName: "Flora Distribution Group LLC",
  clientAddress: "123 Main St, City, State",
  licenseNumber: "LIC-12345",
  cannabinoids: [
    { analyte: "D9-THC", result: "2.5", mgG: "25.0", ... },
    { analyte: "THCa", result: "70.0", mgG: "700.0", ... },
    // ...
  ],
  totalTHC: 72.5,
  totalCBD: 0.3,
  totalCannabinoids: 75.8,
  moisture: 8.2,
  qrCodeUrl: "https://www.quantixanalytics.com/coa/Flora_Distro/Grape_Ape_Badder"
}
```

### Metadata Extraction Script

**Script**: `/Users/whale/Desktop/quantix-new/scripts/parse-coas-with-pdftotext.ts`

**How it works:**
1. Downloads PDF from `file_url`
2. Runs `pdftotext` command to extract text
3. Uses regex patterns to find metadata:
   ```typescript
   const patterns = {
     issue_date: /(?:Completed|Tested)[:\s]+(\d{4}-\d{2}-\d{2})/i,
     thc_total: /Total THC[:\s]+(\d+\.?\d*)\s*%/i,
     cbd_total: /Total CBD[:\s]+(\d+\.?\d*)\s*%/i,
     sample_id: /Sample ID[:\s]+([A-Z0-9-]+)/i,
     batch_id: /Batch[:\s]+([A-Z0-9-]+)/i,
   }
   ```
4. Updates `store_documents.metadata` JSONB field with extracted data

**Test Results** (Grape Ape Badder COA):
```
✅ Completed: 2026-01-24
✅ THC: 72.5%
✅ CBD: 0.3%
✅ Sample ID: QA20260126SL6M
✅ Batch: BAD-2G-THCA-GA-V2
```

## Client Communication Template

### Email to Clients

**Subject:** Action Required: Re-Issue COAs for Quantix Analytics Platform

**Body:**

Hi [Client Name],

We're updating the Quantix Analytics platform to display detailed certificate information (completion dates, cannabinoid profiles, etc.) directly on COA pages.

To enable this feature, we need you to re-issue your COAs using our WhaleTools Generator. This ensures:
- Accurate metadata extraction from PDFs
- Proper QR code URL formatting
- Consistent data across the platform

**What you need to do:**

1. **Gather your product data** for each COA:
   - Product name
   - **Original test completion date** (important!)
   - Cannabinoid values (THC, CBD, etc.)
   - Sample ID, Batch ID
   - Strain and sample type

2. **Use the WhaleTools Generator:**
   - Access at: [URL to Generator]
   - Select your store from the dropdown
   - Fill in the form with your product data
   - **Important**: Use the *original* completion date, not today's date
   - Click "Export" to generate and upload the COA

3. **Repeat for all products**

If you have questions or need help, please contact support@quantixanalytics.com

Thank you!

---

## Next Steps

### Immediate Actions

1. **Test the full workflow** with one client:
   - [ ] Select a test client (suggest using Flora Distro since we have their data)
   - [ ] Use Generator to create 1-2 test COAs
   - [ ] Run parsing script to verify metadata extraction
   - [ ] Check that COA page displays metadata correctly

2. **Document the process** with screenshots:
   - [ ] Screenshot of Generator form filled out
   - [ ] Screenshot of Export process
   - [ ] Screenshot of resulting COA page with metadata

3. **Create client training materials:**
   - [ ] Video walkthrough of Generator
   - [ ] Step-by-step guide with screenshots
   - [ ] FAQ for common issues

### Rollout Strategy

**Option 1: Gradual Rollout**
- Week 1: Pilot with 2-3 clients, collect feedback
- Week 2: Iterate on process, create better documentation
- Week 3-4: Roll out to remaining clients in batches

**Option 2: Self-Service**
- Provide access to Generator with detailed documentation
- Let clients re-issue COAs on their own timeline
- Monitor completion and follow up with stragglers

**Option 3: Quantix Team Does It**
- Collect data from clients via spreadsheet
- Quantix team uses Generator to create COAs for all clients
- Faster but requires more upfront work

---

## Risk Mitigation

### Potential Issues

1. **Clients don't have original completion dates**
   - Solution: Use database `created_at` timestamp as approximation
   - Or: Mark as "Re-issued on [date]" in notes field

2. **Clients don't have cannabinoid values**
   - Solution: Extract from existing PDFs manually
   - Or: Use parsing script on old PDFs where possible

3. **Generator is complex for non-technical users**
   - Solution: Create very detailed step-by-step guide
   - Or: Offer 1-on-1 training sessions

4. **Some clients may resist re-issuing**
   - Solution: Explain benefits (better customer experience, easier verification)
   - Or: Make it optional but encourage participation

### Data Validation

Before deleting old COAs, verify new ones have:
- [ ] Correct product name
- [ ] Valid completion date (not future date, reasonable past date)
- [ ] Cannabinoid values present
- [ ] QR code URL matches format
- [ ] PDF is parseable by pdftotext script
- [ ] Metadata extracted successfully

---

## Success Metrics

- [ ] All active clients have re-issued COAs using Generator
- [ ] 100% of new COAs are parseable (text-based PDFs)
- [ ] Metadata extraction success rate > 95%
- [ ] COA pages display complete metadata (dates, THC/CBD, etc.)
- [ ] Zero customer complaints about missing or incorrect data

---

## Files to Reference

### Quantix Analytics (Display)
- `/Users/whale/Desktop/quantix-new/app/coa/[storeId]/[productSlug]/page.tsx` - COA display page
- `/Users/whale/Desktop/quantix-new/app/api/coa/[storeId]/[productSlug]/route.ts` - COA API endpoint
- `/Users/whale/Desktop/quantix-new/scripts/parse-coas-with-pdftotext.ts` - Metadata extraction script

### WhaleTools Generator
- `/Users/whale/Desktop/Generator/COA/src/app/generate/page.tsx` - Main generation form
- `/Users/whale/Desktop/Generator/COA/supabase/functions/generate-pdf/index.ts` - PDF generation edge function
- `/Users/whale/Desktop/Generator/COA/src/app/api/storage/delete/route.ts` - Storage deletion API

---

## Questions for User

1. **Timeline**: When do you want all clients to complete re-issuance?
2. **Rollout**: Which option (gradual, self-service, or team-does-it)?
3. **Old COAs**: When should we delete old COAs from the database?
4. **Priority clients**: Which clients should re-issue first?
5. **Data sources**: Do clients have access to original test data, or do we need to extract from existing PDFs?
